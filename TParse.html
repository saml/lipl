<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>TParse.lhs -- LIPL</title>
    <link href="style.css" rel="stylesheet" type="text/css" media="screen"/>
    <link href="print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<div id="wrap">
<div class="document" id="tparse-lhs">
<h1 class="title">TParse.lhs</h1>
<p>TParse provides functions for parsing type expressions.
Although LIPL does not allow type annotations,
using type parsing functions, one can write type expressions like:</p>
<pre class="literal-block">
a -&gt; b

instead of

TApp (TApp (TConst &quot;-&gt;&quot;) TVar &quot;a&quot;) (TVar &quot;b&quot;)
</pre>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="kr">module</span> <span class="nn">TParse</span> <span class="kr">where</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Text.ParserCombinators.Parsec</span> <span class="k">as</span> <span class="n">P</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Text.ParserCombinators.Parsec.Token</span> <span class="k">as</span> <span class="n">P</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Text.ParserCombinators.Parsec.Expr</span> <span class="k">as</span> <span class="n">P</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Text.ParserCombinators.Parsec.Language</span> <span class="k">as</span> <span class="n">P</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="nn">Text.ParserCombinators.Parsec</span> <span class="p">((</span><span class="o">&lt;|&gt;</span><span class="p">),</span> <span class="p">(</span><span class="o">&lt;?&gt;</span><span class="p">))</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="nn">ParseUtils</span> <span class="k">hiding</span> <span class="p">(</span><span class="nf">lexer</span><span class="p">)</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="nn">Type</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="nf">tParse</span> <span class="n">texpr</span> <span class="ow">=</span> <span class="kr">case</span> <span class="kt">P</span><span class="o">.</span><span class="n">parse</span> <span class="n">parseExpr</span> <span class="s">&quot;type expression&quot;</span> <span class="n">texpr</span> <span class="kr">of</span>
<span class="cs">&gt;     </span><span class="kt">Right</span> <span class="n">t</span> <span class="ow">-&gt;</span> <span class="n">t</span>
<span class="cs">&gt;     </span><span class="kt">Left</span> <span class="n">err</span> <span class="ow">-&gt;</span> <span class="ne">error</span> <span class="p">(</span><span class="n">show</span> <span class="n">err</span> <span class="o">++</span> <span class="s">&quot;: type expression parse error&quot;</span><span class="p">)</span>
</pre></div>

</div>
<p>tParse parses a type expression to Type.
In case of error, exception is raised (program quits).</p>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="nf">lexer</span>  <span class="ow">=</span> <span class="kt">P</span><span class="o">.</span><span class="n">makeTokenParser</span> <span class="p">(</span><span class="kt">P</span><span class="o">.</span><span class="n">haskellStyle</span> <span class="p">{</span>
<span class="cs">&gt;     </span><span class="kt">P</span><span class="o">.</span><span class="n">reservedOpNames</span> <span class="ow">=</span> <span class="p">[</span><span class="s">&quot;-&gt;&quot;</span><span class="p">]</span>
<span class="cs">&gt;     </span><span class="p">})</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="nf">parens</span> <span class="ow">=</span> <span class="kt">P</span><span class="o">.</span><span class="n">parens</span> <span class="n">lexer</span>
<span class="cs">&gt; </span><span class="nf">reservedOp</span> <span class="ow">=</span> <span class="kt">P</span><span class="o">.</span><span class="n">reservedOp</span> <span class="n">lexer</span>
<span class="cs">&gt; </span><span class="nf">lexeme</span> <span class="ow">=</span> <span class="kt">P</span><span class="o">.</span><span class="n">lexeme</span> <span class="n">lexer</span>
<span class="cs">&gt; </span><span class="nf">term</span> <span class="ow">=</span> <span class="n">lexeme</span> <span class="n">parseType</span> <span class="o">&lt;|&gt;</span> <span class="n">parens</span> <span class="n">expr</span> <span class="o">&lt;?&gt;</span> <span class="s">&quot;term&quot;</span>
</pre></div>

</div>
<p>parens takes a parser and creates a parser that
parses what the given parser parses
enclosed in parenthesis:</p>
<pre class="literal-block">
parens p
==&gt; parses ( what p parses )
</pre>
<p>reservedOp takes a String and creates a parser that
accepts input that is same as the given String.
The given String can be the reserved operator (<tt class="docutils literal"><span class="pre">-&gt;</span></tt>).</p>
<p>lexeme takes a parser and creates a parser that
accepts what the given parser accepts and skips whitespaces
after parsing.</p>
<p>term parses what parseType parses or parenthesized expr.</p>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="nf">expr</span> <span class="ow">=</span> <span class="kt">P</span><span class="o">.</span><span class="n">buildExpressionParser</span> <span class="n">table</span> <span class="n">term</span> <span class="o">&lt;?&gt;</span> <span class="s">&quot;expr&quot;</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="nf">table</span> <span class="ow">=</span> <span class="p">[</span>
<span class="cs">&gt;     </span><span class="p">[</span><span class="kt">P</span><span class="o">.</span><span class="kt">Infix</span> <span class="p">(</span><span class="kr">do</span>
<span class="cs">&gt;         </span><span class="nf">reservedOp</span> <span class="s">&quot;-&gt;&quot;</span>
<span class="cs">&gt;         </span><span class="nf">return</span> <span class="n">fn</span>
<span class="cs">&gt;         </span><span class="o">&lt;?&gt;</span> <span class="s">&quot;operator&quot;</span><span class="p">)</span> <span class="kt">P</span><span class="o">.</span><span class="kt">AssocRight</span><span class="p">]]</span>
</pre></div>

</div>
<p>expr parses terms connected with <tt class="docutils literal"><span class="pre">-&gt;</span></tt>:</p>
<pre class="literal-block">
term1 -&gt; term2 -&gt; term3 ...
</pre>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="nf">parseExpr</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="nf">t</span> <span class="ow">&lt;-</span> <span class="n">expr</span>
<span class="cs">&gt;     </span><span class="kt">P</span><span class="o">.</span><span class="n">eof</span>
<span class="cs">&gt;     </span><span class="nf">return</span> <span class="n">t</span> <span class="o">&lt;?&gt;</span> <span class="s">&quot;Expression&quot;</span>
</pre></div>

</div>
<p>parseExpr parses a type expression.</p>
<p>Below parsers are straight forward:</p>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="nf">parseTVar</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="nf">x</span> <span class="ow">&lt;-</span> <span class="kt">P</span><span class="o">.</span><span class="n">letter</span>
<span class="cs">&gt;     </span><span class="nf">xs</span> <span class="ow">&lt;-</span> <span class="kt">P</span><span class="o">.</span><span class="n">many</span> <span class="kt">P</span><span class="o">.</span><span class="n">alphaNum</span>
<span class="cs">&gt;     </span><span class="nf">return</span> <span class="p">(</span><span class="kt">TVar</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">))</span> <span class="o">&lt;?&gt;</span> <span class="s">&quot;Variable&quot;</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="nf">parseFunc</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="nf">t1</span> <span class="ow">&lt;-</span> <span class="n">parseType</span>
<span class="cs">&gt;     </span><span class="kt">P</span><span class="o">.</span><span class="n">spaces</span>
<span class="cs">&gt;     </span><span class="kt">P</span><span class="o">.</span><span class="n">string</span> <span class="s">&quot;-&gt;&quot;</span>
<span class="cs">&gt;     </span><span class="kt">P</span><span class="o">.</span><span class="n">spaces</span>
<span class="cs">&gt;     </span><span class="nf">t2</span> <span class="ow">&lt;-</span> <span class="n">parseType</span>
<span class="cs">&gt;     </span><span class="nf">return</span> <span class="p">(</span><span class="n">t1</span> <span class="p">`</span><span class="n">fn</span><span class="p">`</span> <span class="n">t2</span><span class="p">)</span> <span class="o">&lt;?&gt;</span> <span class="s">&quot;Function&quot;</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="nf">parseInt</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="kt">P</span><span class="o">.</span><span class="n">string</span> <span class="s">&quot;Int&quot;</span>
<span class="cs">&gt;     </span><span class="nf">return</span> <span class="n">tInt</span> <span class="o">&lt;?&gt;</span> <span class="s">&quot;Int&quot;</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="nf">parseFloat</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="kt">P</span><span class="o">.</span><span class="n">string</span> <span class="s">&quot;Float&quot;</span>
<span class="cs">&gt;     </span><span class="nf">return</span> <span class="n">tFloat</span> <span class="o">&lt;?&gt;</span> <span class="s">&quot;Float&quot;</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="nf">parseBool</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="kt">P</span><span class="o">.</span><span class="n">string</span> <span class="s">&quot;Bool&quot;</span>
<span class="cs">&gt;     </span><span class="nf">return</span> <span class="n">tBool</span> <span class="o">&lt;?&gt;</span> <span class="s">&quot;Bool&quot;</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="nf">parseChar</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="kt">P</span><span class="o">.</span><span class="n">string</span> <span class="s">&quot;Char&quot;</span> <span class="o">&lt;?&gt;</span> <span class="s">&quot;Char&quot;</span>
<span class="cs">&gt;     </span><span class="nf">return</span> <span class="n">tChar</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="nf">parseStr</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="kt">P</span><span class="o">.</span><span class="n">string</span> <span class="s">&quot;Str&quot;</span> <span class="o">&lt;?&gt;</span> <span class="s">&quot;Str&quot;</span>
<span class="cs">&gt;     </span><span class="nf">return</span> <span class="o">$</span> <span class="n">list</span> <span class="n">tChar</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="nf">parseList</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="nf">lbracket</span>
<span class="cs">&gt;     </span><span class="nf">t</span> <span class="ow">&lt;-</span> <span class="n">term</span>
<span class="cs">&gt;     </span><span class="nf">rbracket</span>
<span class="cs">&gt;     </span><span class="nf">return</span> <span class="p">(</span><span class="n">list</span> <span class="n">t</span><span class="p">)</span> <span class="o">&lt;?&gt;</span> <span class="s">&quot;List&quot;</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="nf">parseUnit</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="nf">lparen</span>
<span class="cs">&gt;     </span><span class="nf">rparen</span>
<span class="cs">&gt;     </span><span class="nf">return</span> <span class="n">tUnit</span> <span class="o">&lt;?&gt;</span> <span class="s">&quot;Unit&quot;</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="nf">parsePair</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="nf">lparen</span>
<span class="cs">&gt;     </span><span class="nf">t1</span> <span class="ow">&lt;-</span> <span class="n">parseType</span>
<span class="cs">&gt;     </span><span class="nf">comma</span>
<span class="cs">&gt;     </span><span class="nf">t2</span> <span class="ow">&lt;-</span> <span class="n">parseType</span>
<span class="cs">&gt;     </span><span class="nf">rparen</span>
<span class="cs">&gt;     </span><span class="nf">return</span> <span class="p">(</span><span class="n">pair</span> <span class="n">t1</span> <span class="n">t2</span><span class="p">)</span> <span class="o">&lt;?&gt;</span> <span class="s">&quot;Pair&quot;</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="nf">parseType</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="kt">P</span><span class="o">.</span><span class="n">try</span> <span class="n">parseList</span>
<span class="cs">&gt;     </span><span class="o">&lt;|&gt;</span> <span class="kt">P</span><span class="o">.</span><span class="n">try</span> <span class="n">parseInt</span>
<span class="cs">&gt;     </span><span class="o">&lt;|&gt;</span> <span class="kt">P</span><span class="o">.</span><span class="n">try</span> <span class="n">parseFloat</span>
<span class="cs">&gt;     </span><span class="o">&lt;|&gt;</span> <span class="kt">P</span><span class="o">.</span><span class="n">try</span> <span class="n">parseBool</span>
<span class="cs">&gt;     </span><span class="o">&lt;|&gt;</span> <span class="kt">P</span><span class="o">.</span><span class="n">try</span> <span class="n">parseChar</span>
<span class="cs">&gt;     </span><span class="o">&lt;|&gt;</span> <span class="kt">P</span><span class="o">.</span><span class="n">try</span> <span class="n">parseStr</span>
<span class="cs">&gt;     </span><span class="o">&lt;|&gt;</span> <span class="kt">P</span><span class="o">.</span><span class="n">try</span> <span class="n">parsePair</span>
<span class="cs">&gt;     </span><span class="o">&lt;|&gt;</span> <span class="kt">P</span><span class="o">.</span><span class="n">try</span> <span class="n">parseUnit</span>
<span class="cs">&gt;     </span><span class="o">&lt;|&gt;</span> <span class="kt">P</span><span class="o">.</span><span class="n">try</span> <span class="n">parseTVar</span>
</pre></div>

</div>
<p>parseType parses any valid Type:</p>
<pre class="literal-block">
Int, Bool, [((Int -&gt; a) -&gt; b -&gt; Char)], [Char] -&gt; a, ...
</pre>
<p>Note that parenthesis are needed in <tt class="docutils literal">[(a <span class="pre">-&gt;</span> b)]</tt> because
parseList expects a term inside <tt class="docutils literal">[ ]</tt>.
<tt class="docutils literal">[a <span class="pre">-&gt;</span> b]</tt> won't get parsed.</p>
</div>

</div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-2157648-2");
pageTracker._initData();
pageTracker._trackPageview();
</script>
</body>
</html>
