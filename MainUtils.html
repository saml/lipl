<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>MainUtils.lhs -- LIPL</title>
    <link href="style.css" rel="stylesheet" type="text/css" media="screen"/>
    <link href="print.css" rel="stylesheet" type="text/css" media="print"/>
</head>
<body>
<div id="wrap">
<div class="document" id="mainutils-lhs">
<h1 class="title">MainUtils.lhs</h1>
<p>MainUtils implements various actions used in Main program.</p>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="kr">module</span> <span class="nn">MainUtils</span> <span class="p">(</span><span class="nf">run</span><span class="p">,</span> <span class="nf">module</span> <span class="kt">MainUtils</span><span class="p">)</span> <span class="kr">where</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="nn">System.IO</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="nn">System.Directory</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="nn">System.FilePath</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Control.Exception</span> <span class="k">as</span> <span class="n">Ex</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="k">qualified</span> <span class="nn">System.Environment</span> <span class="k">as</span> <span class="n">Sys</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Control.Monad.Error</span> <span class="k">as</span> <span class="n">E</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Control.Monad.State</span> <span class="k">as</span> <span class="n">S</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Control.Monad.Trans</span> <span class="k">as</span> <span class="n">T</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Control.Monad</span> <span class="k">as</span> <span class="n">M</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Text.ParserCombinators.Parsec</span> <span class="k">as</span> <span class="n">P</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="nn">Text.ParserCombinators.Parsec.Pos</span> <span class="p">(</span><span class="kt">SourceName</span><span class="p">)</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="nn">Evaluator</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="nn">Parser</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="nn">LangData</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="nn">TCheck</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="nn">Error</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="nn">TIMonad</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="nn">EvalMonad</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="nn">REPLMonad</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="nn">Type</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="nn">Settings</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="nn">PosMonad</span>
<span class="cs">&gt; </span><span class="kr">import</span> <span class="nn">Utils</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="nf">liplPath</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="nf">path</span> <span class="ow">&lt;-</span> <span class="kt">Ex</span><span class="o">.</span><span class="n">handle</span> <span class="p">(</span><span class="nf">\</span><span class="n">e</span> <span class="ow">-&gt;</span> <span class="n">return</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="p">(</span><span class="kt">Sys</span><span class="o">.</span><span class="n">getEnv</span> <span class="n">sPATH</span><span class="p">)</span>
<span class="cs">&gt;     </span><span class="nf">base</span> <span class="ow">&lt;-</span> <span class="n">baseDir</span>
<span class="cs">&gt;     </span><span class="nf">return</span> <span class="p">(</span><span class="n">splitOn</span> <span class="n">searchPathSeparator</span> <span class="n">path</span> <span class="o">++</span> <span class="p">[</span><span class="n">base</span><span class="p">])</span>
</pre></div>

</div>
<p>liplPath returns list of directories defined in LIPLPATH
environment variable plus baseDir (<tt class="docutils literal"><span class="pre">~/.lipl</span></tt>).</p>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="nf">baseDir</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="nf">home</span> <span class="ow">&lt;-</span> <span class="n">getHomeDirectory</span>
<span class="cs">&gt;     </span><span class="nf">return</span> <span class="o">$</span> <span class="n">joinPath</span> <span class="p">[</span><span class="n">home</span><span class="p">,</span> <span class="n">sBASEDIR</span><span class="p">]</span>
</pre></div>

</div>
<p>baseDir returns <tt class="docutils literal"><span class="pre">~/.lipl</span></tt>.</p>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="nf">createBaseDir</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="nf">d</span> <span class="ow">&lt;-</span> <span class="n">baseDir</span>
<span class="cs">&gt;     </span><span class="nf">exists</span> <span class="ow">&lt;-</span> <span class="n">doesDirectoryExist</span> <span class="n">d</span>
<span class="cs">&gt;     </span><span class="kr">if</span> <span class="n">exists</span> <span class="kr">then</span> <span class="n">return</span> <span class="nb">()</span> <span class="kr">else</span> <span class="n">createDirectory</span> <span class="n">d</span>
</pre></div>

</div>
<p>createBaseDir creats <tt class="docutils literal"><span class="pre">~/.lipl</span></tt> if it does not exist.</p>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="nf">getValidFile</span> <span class="n">l</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="nf">yes</span> <span class="ow">&lt;-</span> <span class="n">mapM</span> <span class="n">doesFileExist</span> <span class="n">l</span>
<span class="cs">&gt;     </span><span class="nf">getFirst</span> <span class="p">(</span><span class="n">zip</span> <span class="n">yes</span> <span class="n">l</span><span class="p">)</span>
<span class="cs">&gt;     </span><span class="kr">where</span>
<span class="cs">&gt;         </span><span class="nf">getFirst</span> <span class="kt">[]</span> <span class="ow">=</span> <span class="n">return</span> <span class="s">&quot;&quot;</span>
<span class="cs">&gt;         </span><span class="nf">getFirst</span> <span class="p">((</span><span class="kt">True</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="kt">:</span><span class="kr">_</span><span class="p">)</span> <span class="ow">=</span> <span class="n">return</span> <span class="n">x</span>
<span class="cs">&gt;         </span><span class="nf">getFirst</span> <span class="p">(</span><span class="kr">_</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span> <span class="ow">=</span> <span class="n">getFirst</span> <span class="n">xs</span>
</pre></div>

</div>
<p>getValidFile takes a list of file paths and
returns the first file that actually exists.
If nothing in the list exists, &quot;&quot; is returned.</p>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="nf">findPrelude</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="nf">exists</span> <span class="ow">&lt;-</span> <span class="n">doesFileExist</span> <span class="n">sPRELUDE</span>
<span class="cs">&gt;     </span><span class="kr">if</span> <span class="n">exists</span>
<span class="cs">&gt;         </span><span class="kr">then</span>
<span class="cs">&gt;             </span><span class="nf">return</span> <span class="n">sPRELUDE</span>
<span class="cs">&gt;         </span><span class="kr">else</span>
<span class="cs">&gt;             </span><span class="kr">do</span>
<span class="cs">&gt;                 </span><span class="nf">paths</span> <span class="ow">&lt;-</span> <span class="n">liplPath</span>
<span class="cs">&gt;                 </span><span class="kr">let</span> <span class="n">fs</span> <span class="ow">=</span> <span class="n">map</span> <span class="p">(</span><span class="nf">\</span><span class="n">x</span> <span class="ow">-&gt;</span> <span class="n">joinPath</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">sPRELUDE</span><span class="p">])</span> <span class="n">paths</span>
<span class="cs">&gt;                 </span><span class="nf">f</span> <span class="ow">&lt;-</span> <span class="n">getValidFile</span> <span class="n">fs</span>
<span class="cs">&gt;                 </span><span class="nf">return</span> <span class="n">f</span>
</pre></div>

</div>
<p>findPrelude returns location of <tt class="docutils literal">core.lipl</tt> file.
It searches for <tt class="docutils literal">core.lipl</tt> in the following order:</p>
<p>1. in the current working directory.
1. in directories listed in LIPLPATH environment variable.
1. in <tt class="docutils literal"><span class="pre">~/.lipl</span></tt>.</p>
<p>If <tt class="docutils literal">core.lipl</tt> is not found, &quot;&quot; is returned.</p>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="nf">loadPrelude</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="nf">fname</span> <span class="ow">&lt;-</span> <span class="kt">T</span><span class="o">.</span><span class="n">liftIO</span> <span class="n">findPrelude</span>
<span class="cs">&gt;     </span><span class="nf">runAndPrint</span> <span class="p">(</span><span class="n">loadFile</span> <span class="n">fname</span><span class="p">)</span>
</pre></div>

</div>
<p>loadPrelude loads <tt class="docutils literal">core.lipl</tt>.
It can fail when <tt class="docutils literal">core.lipl</tt> cannot be found.</p>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="nf">runAndPrint</span> <span class="n">action</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="nf">msg</span> <span class="ow">&lt;-</span> <span class="n">action</span>
<span class="cs">&gt;     </span><span class="kt">T</span><span class="o">.</span><span class="n">liftIO</span> <span class="o">$</span> <span class="n">putStrLn</span> <span class="n">msg</span>
</pre></div>

</div>
<p>runAndPrint runs an action that returns String and prints the String.</p>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="nf">println</span> <span class="n">s</span> <span class="ow">=</span> <span class="kt">T</span><span class="o">.</span><span class="n">liftIO</span> <span class="o">$</span> <span class="n">putStrLn</span> <span class="n">s</span>
</pre></div>

</div>
<p>println is short hand for <tt class="docutils literal">liftIO . putStrLn</tt>.</p>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="nf">repl</span> <span class="ow">::</span> <span class="kt">REPL</span> <span class="nb">()</span>
<span class="cs">&gt; </span><span class="nf">repl</span> <span class="ow">=</span> <span class="p">(</span><span class="kr">do</span>
<span class="cs">&gt;     </span><span class="nf">line</span> <span class="ow">&lt;-</span> <span class="kt">M</span><span class="o">.</span><span class="n">liftM</span> <span class="p">(</span><span class="n">unwords</span> <span class="o">.</span> <span class="n">words</span><span class="p">)</span>
<span class="cs">&gt;         </span><span class="o">$</span> <span class="kt">T</span><span class="o">.</span><span class="n">liftIO</span> <span class="o">$</span> <span class="n">prompt</span> <span class="p">(</span><span class="n">sLANGNAME</span> <span class="o">++</span> <span class="s">&quot;&gt; &quot;</span><span class="p">)</span>
<span class="cs">&gt;     </span><span class="kr">if</span> <span class="n">length</span> <span class="n">line</span> <span class="o">==</span> <span class="mi">0</span>
<span class="cs">&gt;         </span><span class="kr">then</span>
<span class="cs">&gt;             </span><span class="nf">repl</span>
<span class="cs">&gt;         </span><span class="kr">else</span>
<span class="cs">&gt;             </span><span class="nf">processInput</span> <span class="n">line</span><span class="p">)</span> <span class="p">`</span><span class="kt">E</span><span class="o">.</span><span class="n">catchError</span><span class="p">`</span>
<span class="cs">&gt;                 </span><span class="p">(</span><span class="nf">\</span><span class="n">e</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
<span class="cs">&gt;                     </span><span class="nf">println</span> <span class="p">(</span><span class="n">show</span> <span class="n">e</span><span class="p">)</span>
<span class="cs">&gt;                     </span><span class="nf">repl</span><span class="p">)</span>
</pre></div>

</div>
<p>repl is read eval print loop. It runs in REPL monad.</p>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="nf">loadFile</span> <span class="n">fileName</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="nf">result</span> <span class="ow">&lt;-</span> <span class="p">(</span><span class="n">interpret</span> <span class="n">fileName</span> <span class="o">&gt;&gt;</span>
<span class="cs">&gt;         </span><span class="nf">return</span> <span class="p">(</span><span class="n">fileName</span> <span class="o">++</span> <span class="s">&quot; loaded&quot;</span><span class="p">))</span>
<span class="cs">&gt;     </span><span class="nf">return</span> <span class="n">result</span>
</pre></div>

</div>
<p>loadFile loads a LIPL file.</p>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="nf">interpret</span> <span class="ow">::</span> <span class="kt">FilePath</span> <span class="ow">-&gt;</span> <span class="kt">REPL</span> <span class="nb">()</span>
<span class="cs">&gt; </span><span class="nf">interpret</span> <span class="n">file</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="nf">isValidFile</span> <span class="ow">&lt;-</span> <span class="kt">T</span><span class="o">.</span><span class="n">liftIO</span> <span class="o">$</span> <span class="n">doesFileExist</span> <span class="n">file</span>
<span class="cs">&gt;     </span><span class="kr">if</span> <span class="n">isValidFile</span>
<span class="cs">&gt;         </span><span class="kr">then</span>
<span class="cs">&gt;             </span><span class="kr">do</span>
<span class="cs">&gt;                 </span><span class="nf">prog</span> <span class="ow">&lt;-</span> <span class="kt">T</span><span class="o">.</span><span class="n">liftIO</span> <span class="o">$</span> <span class="n">readFile</span> <span class="n">file</span>
<span class="cs">&gt;                 </span><span class="nf">rollBackOnErr</span> <span class="p">(</span><span class="n">parseAndEvalMultiple</span> <span class="n">file</span> <span class="n">prog</span><span class="p">)</span>
<span class="cs">&gt;                 </span><span class="nf">return</span> <span class="nb">()</span>
<span class="cs">&gt;         </span><span class="kr">else</span> <span class="kt">E</span><span class="o">.</span><span class="n">throwError</span> <span class="o">$</span> <span class="kt">Default</span> <span class="p">(</span><span class="s">&quot;can&#39;t find file: &quot;</span> <span class="o">++</span> <span class="n">file</span><span class="p">)</span>
</pre></div>

</div>
<p>interpret interprets a LIPL file
by evaluating one LIPL expression at a time, expanding
environment in REPL monad as needed (for example, function
definition registers new function name to the environment).
In case of error, REPL monad's state is restored.
Only when all expressions in the file are successfully evaluated,
REPL monad's state is committed.</p>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="nf">processInput</span> <span class="n">line</span> <span class="ow">=</span>
<span class="cs">&gt;     </span><span class="kr">case</span> <span class="p">(</span><span class="n">head</span> <span class="o">.</span> <span class="n">words</span><span class="p">)</span> <span class="n">line</span> <span class="kr">of</span>
<span class="cs">&gt;         </span><span class="s">&quot;:?&quot;</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
<span class="cs">&gt;             </span><span class="nf">println</span> <span class="p">(</span><span class="n">unlines</span> <span class="p">[</span><span class="s">&quot;:? help&quot;</span>
<span class="cs">&gt;                 </span><span class="p">,</span> <span class="s">&quot;:s current type environment&quot;</span>
<span class="cs">&gt;                 </span><span class="p">,</span> <span class="s">&quot;:q quit&quot;</span>
<span class="cs">&gt;                 </span><span class="p">,</span> <span class="s">&quot;:e current environment&quot;</span>
<span class="cs">&gt;                 </span><span class="p">,</span> <span class="s">&quot;:c clear environment&quot;</span>
<span class="cs">&gt;                 </span><span class="p">,</span> <span class="s">&quot;:l &lt;file&gt; load &lt;file&gt;&quot;</span>
<span class="cs">&gt;                 </span><span class="p">,</span> <span class="s">&quot;:r &lt;file&gt; load &lt;file&gt; on clean environment&quot;</span><span class="p">])</span>
<span class="cs">&gt;             </span><span class="nf">repl</span>
<span class="cs">&gt;         </span><span class="s">&quot;:s&quot;</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
<span class="cs">&gt;             </span><span class="nf">println</span> <span class="s">&quot;Current Type Environment&quot;</span>
<span class="cs">&gt;             </span><span class="nf">printSubst</span>
<span class="cs">&gt;             </span><span class="nf">repl</span>
<span class="cs">&gt;         </span><span class="s">&quot;:q&quot;</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
<span class="cs">&gt;             </span><span class="nf">println</span> <span class="s">&quot;bye&quot;</span>
<span class="cs">&gt;             </span><span class="nf">return</span> <span class="nb">()</span>
<span class="cs">&gt;         </span><span class="s">&quot;:e&quot;</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
<span class="cs">&gt;             </span><span class="nf">println</span> <span class="s">&quot;Current Environment&quot;</span>
<span class="cs">&gt;             </span><span class="nf">printEnv</span>
<span class="cs">&gt;             </span><span class="nf">repl</span>
<span class="cs">&gt;         </span><span class="s">&quot;:pop&quot;</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
<span class="cs">&gt;             </span><span class="nf">println</span> <span class="s">&quot;Pop Environment&quot;</span>
<span class="cs">&gt;             </span><span class="nf">popEnv</span>
<span class="cs">&gt;             </span><span class="nf">printEnv</span>
<span class="cs">&gt;             </span><span class="nf">repl</span>
<span class="cs">&gt;         </span><span class="s">&quot;:c&quot;</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
<span class="cs">&gt;             </span><span class="nf">clearEnvs</span>
<span class="cs">&gt;             </span><span class="nf">println</span> <span class="s">&quot;Environment cleared&quot;</span>
<span class="cs">&gt;             </span><span class="nf">printEnv</span>
<span class="cs">&gt;             </span><span class="nf">clearSubst</span>
<span class="cs">&gt;             </span><span class="nf">println</span> <span class="s">&quot;Type environment cleared&quot;</span>
<span class="cs">&gt;             </span><span class="nf">repl</span>
<span class="cs">&gt;         </span><span class="s">&quot;:l&quot;</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
<span class="cs">&gt;             </span><span class="nf">result</span> <span class="ow">&lt;-</span> <span class="n">loadFile</span> <span class="o">$</span> <span class="p">(</span><span class="n">head</span> <span class="o">.</span> <span class="n">tail</span> <span class="o">.</span> <span class="n">words</span><span class="p">)</span> <span class="n">line</span>
<span class="cs">&gt;             </span><span class="nf">println</span> <span class="n">result</span>
<span class="cs">&gt;             </span><span class="nf">repl</span>
<span class="cs">&gt;         </span><span class="s">&quot;:r&quot;</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
<span class="cs">&gt;             </span><span class="nf">clearEnvs</span>
<span class="cs">&gt;             </span><span class="nf">println</span> <span class="s">&quot;Environment cleared&quot;</span>
<span class="cs">&gt;             </span><span class="nf">clearSubst</span>
<span class="cs">&gt;             </span><span class="nf">println</span> <span class="s">&quot;Type environment cleared&quot;</span>
<span class="cs">&gt;             </span><span class="nf">loadPrelude</span>
<span class="cs">&gt;             </span><span class="nf">result</span> <span class="ow">&lt;-</span> <span class="n">loadFile</span> <span class="o">$</span> <span class="p">(</span><span class="n">head</span> <span class="o">.</span> <span class="n">tail</span> <span class="o">.</span> <span class="n">words</span><span class="p">)</span> <span class="n">line</span>
<span class="cs">&gt;             </span><span class="nf">println</span> <span class="n">result</span>
<span class="cs">&gt;             </span><span class="nf">repl</span>
<span class="cs">&gt;         </span><span class="nf">otherwise</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
<span class="cs">&gt;             </span><span class="nf">result</span> <span class="ow">&lt;-</span> <span class="p">(</span><span class="n">show</span> <span class="p">`</span><span class="n">fmap</span><span class="p">`</span> <span class="n">rollBackOnErr</span> <span class="p">(</span><span class="n">parseAndEval</span> <span class="n">line</span><span class="p">))</span>
<span class="cs">&gt;             </span><span class="nf">println</span> <span class="n">result</span>
<span class="cs">&gt;             </span><span class="nf">repl</span>
</pre></div>

</div>
<p>processInput parses various repl commands (:l, :c, :s, ...etc.
commands start with :)
and performs various actions according to the given commands.
When the user input was not a repl command, it considers
the input to be a LIPL expression and evaluates the input
(also type inference is performed).</p>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="nf">printSubst</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="nf">s</span> <span class="ow">&lt;-</span> <span class="n">getSubst</span>
<span class="cs">&gt;     </span><span class="kt">T</span><span class="o">.</span><span class="n">liftIO</span> <span class="o">$</span> <span class="n">putStrLn</span> <span class="p">(</span><span class="n">showSubst</span> <span class="n">s</span><span class="p">)</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="nf">printEnv</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="nf">env</span> <span class="ow">&lt;-</span> <span class="n">getEnvs</span>
<span class="cs">&gt;     </span><span class="kt">T</span><span class="o">.</span><span class="n">liftIO</span> <span class="o">$</span> <span class="n">putStrLn</span> <span class="p">(</span><span class="n">showEnvs</span> <span class="n">env</span><span class="p">)</span>
</pre></div>

</div>
<p>printSubst prints current Subst (variable type information).
printEnv prints current Env (variable value information).
printEnv does not print about built-in functions while printSubst
does.</p>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="nf">parseAndEval</span> <span class="ow">::</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">REPL</span> <span class="kt">Val</span>
<span class="cs">&gt; </span><span class="nf">parseAndEval</span> <span class="n">input</span> <span class="ow">=</span> <span class="kr">case</span> <span class="n">parseSingle</span> <span class="n">input</span> <span class="kr">of</span>
<span class="cs">&gt;     </span><span class="kt">Left</span> <span class="n">err</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
<span class="cs">&gt;         </span><span class="kt">E</span><span class="o">.</span><span class="n">throwError</span> <span class="o">$</span> <span class="kt">Default</span> <span class="p">(</span><span class="n">show</span> <span class="n">err</span><span class="p">)</span>
<span class="cs">&gt;     </span><span class="kt">Right</span> <span class="n">val</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
<span class="cs">&gt;         </span><span class="nf">t</span> <span class="ow">&lt;-</span> <span class="n">typeInfer</span> <span class="n">val</span>
<span class="cs">&gt;         </span><span class="nf">println</span> <span class="p">(</span><span class="s">&quot;type: &quot;</span> <span class="o">++</span> <span class="n">show</span> <span class="n">t</span><span class="p">)</span>
<span class="cs">&gt;         </span><span class="nf">evaluate</span> <span class="n">val</span>
<span class="cs">&gt;</span>
<span class="cs">&gt; </span><span class="nf">parseAndEvalMultiple</span> <span class="ow">::</span> <span class="kt">SourceName</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">REPL</span> <span class="kt">Val</span>
<span class="cs">&gt; </span><span class="nf">parseAndEvalMultiple</span> <span class="n">fn</span> <span class="n">input</span> <span class="ow">=</span> <span class="kr">case</span> <span class="n">parseMultiple</span> <span class="n">fn</span> <span class="n">input</span> <span class="kr">of</span>
<span class="cs">&gt;     </span><span class="kt">Left</span> <span class="n">err</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
<span class="cs">&gt;         </span><span class="kt">E</span><span class="o">.</span><span class="n">throwError</span> <span class="o">$</span> <span class="kt">Default</span> <span class="p">(</span><span class="n">show</span> <span class="n">err</span><span class="p">)</span>
<span class="cs">&gt;     </span><span class="kt">Right</span> <span class="n">vals</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
<span class="cs">&gt;         </span><span class="kt">M</span><span class="o">.</span><span class="n">mapM</span> <span class="p">(</span><span class="nf">\</span><span class="n">val</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kr">do</span>
<span class="cs">&gt;             </span><span class="nf">t</span> <span class="ow">&lt;-</span> <span class="n">typeInfer</span> <span class="n">val</span>
<span class="cs">&gt;             </span><span class="nf">return</span> <span class="n">t</span><span class="p">))</span> <span class="n">vals</span>
<span class="cs">&gt;         </span><span class="kt">M</span><span class="o">.</span><span class="n">mapM</span> <span class="n">evaluate</span> <span class="n">vals</span>
<span class="cs">&gt;         </span><span class="nf">return</span> <span class="kt">Null</span>
</pre></div>

</div>
<p>parseAndEval considers the input to be a single LIPL expression.
It infers type of the expression and evaluates it, printing
both type and result upon success.
parseAndEvalMultiple considers the input to be a series of LIPL
expressions. It infers type of each expression and evaluates it,
while modifying state of REPL monad (for example,
function definition registers both type information and
value information for the function name).</p>
<p>Because of how parseAndEvalMultiple is implemented
(using mapM), a LIPL file is executed from top to bottom.
So, one must define a function before it can be used.</p>
<div class="syntax lhs">
<div class="highlight"><pre><span class="cs">&gt; </span><span class="nf">prompt</span> <span class="ow">::</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="kt">String</span>
<span class="cs">&gt; </span><span class="nf">prompt</span> <span class="n">p</span> <span class="ow">=</span> <span class="kr">do</span>
<span class="cs">&gt;     </span><span class="nf">putStr</span> <span class="n">p</span>
<span class="cs">&gt;     </span><span class="nf">hFlush</span> <span class="n">stdout</span>
<span class="cs">&gt;     </span><span class="nf">getLine</span>
</pre></div>

</div>
<p>prompt prompts user for input and returns what user entered.</p>
</div>

</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-31053646-3']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</body>
</html>
